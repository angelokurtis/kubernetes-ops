receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: apps
          scrape_interval: 5s
          honor_labels: true
          kubernetes_sd_configs:
            - role: pod
              selectors:
                - role: pod
                  # only scrape data from pods running on the same node as collector
                  field: "spec.nodeName=$KUBE_NODE_NAME"
          relabel_configs:
            # prometheus annotations
            - action: keep
              regex: true
              source_labels:
                - __meta_kubernetes_pod_annotation_prometheus_io_scrape
            - action: drop
              regex: true
              source_labels:
                - __meta_kubernetes_pod_annotation_prometheus_io_scrape_slow
            - action: replace
              regex: (https?)
              source_labels:
                - __meta_kubernetes_pod_annotation_prometheus_io_scheme
              target_label: __scheme__
            - action: replace
              regex: (.+)
              source_labels:
                - __meta_kubernetes_pod_annotation_prometheus_io_path
              target_label: __metrics_path__
            - action: replace
              regex: (.+?)(?::\d+)?;(\d+)
              replacement: $$1:$$2
              source_labels:
                - __address__
                - __meta_kubernetes_pod_annotation_prometheus_io_port
              target_label: __address__
            - action: labelmap
              regex: __meta_kubernetes_pod_annotation_prometheus_io_param_(.+)
              replacement: __param_$$1

            # job name replacement
            - action: labelmap
              regex: __meta_kubernetes_pod_label_app
              replacement: __app_name
            - action: labelmap
              regex: __meta_kubernetes_pod_label_app_kubernetes_io_name
              replacement: __app_name
            - action: drop
              regex: ''
              source_labels: [ __app_name ]
            - action: replace
              source_labels: [ __app_name ]
              target_label: job

            # others
            - action: replace
              source_labels: [ __meta_kubernetes_namespace ]
              target_label: namespace
            - action: drop
              regex: Pending|Succeeded|Failed|Completed
              source_labels: [ __meta_kubernetes_pod_phase ]

exporters:
  logging:
    loglevel: debug
  prometheusremotewrite:
    endpoint: http://$PROMETHEUS_PUSHGATEWAY_ENDPOINT/api/v1/write

service:
  telemetry:
    metrics:
      address: ":8888"
    logs:
      level: debug
  pipelines:
    metrics:
      receivers: [ prometheus ]
      exporters: [ logging, prometheusremotewrite ]
